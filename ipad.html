<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>10 Hz AV Stim – iOS Click Unlock</title>
  <style>
    html,body{
      margin:0;padding:0;height:100%;width:100%;overflow:hidden;
      background:black;color:white;font-family:sans-serif;
      display:flex;align-items:center;justify-content:center;
      touch-action:manipulation;-webkit-user-select:none;user-select:none;
    }
    #flash{position:fixed;top:0;left:0;width:100vw;height:100vh;background:black;z-index:1;}
    #controls{z-index:2;background:rgba(0,0,0,0.8);padding:1em 2em;border-radius:1em;text-align:center;}
    input{font-size:1em;width:4em;text-align:center;}
    button{font-size:1.4em;padding:0.5em 1.2em;border:none;border-radius:0.5em;background:#00bcd4;color:white;}
    button:active{background:#0097a7;}
  </style>
</head>
<body>
  <div id="flash"></div>
  <div id="controls">
    <h2>iOS Audio‑Visual Stim</h2>
    <p>Tap start to begin flicker + beep</p>
    <label>Freq (Hz): <input type="number" id="freq" value="10" min="1" max="60"></label><br><br>
    <label>Duty (%): <input type="number" id="duty" value="50" min="1" max="99"></label><br><br>
    <button id="toggle">Start</button>
  </div>

  <script>
    const flash=document.getElementById('flash');
    const controls=document.getElementById('controls');
    const toggle=document.getElementById('toggle');
    const freqInput=document.getElementById('freq');
    const dutyInput=document.getElementById('duty');

    let running=false;
    let audioCtx=null,osc=null,gainNode=null,stimInterval=null;

    function playClickUnlock(){
      const ctx=audioCtx;
      const buffer=ctx.createBuffer(1,ctx.sampleRate*0.01,ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=Math.sin(i/5)*Math.exp(-i/100);
      const src=ctx.createBufferSource();
      src.buffer=buffer;
      src.connect(ctx.destination);
      src.start(0);
    }

    function startAV(){
      running=true;
      controls.style.display='none';

      const freq=Math.max(1,parseFloat(freqInput.value)||10);
      const duty=Math.max(0.01,Math.min(0.99,(parseFloat(dutyInput.value)||50)/100));
      const period=1000/freq;
      const onTime=period*duty;

      gainNode=audioCtx.createGain();
      gainNode.gain.value=0;
      gainNode.connect(audioCtx.destination);

      osc=audioCtx.createOscillator();
      osc.type='square';
      osc.frequency.value=1000;
      osc.connect(gainNode);
      osc.start();

      function cycle(){
        if(!running)return;
        flash.style.background='white';
        gainNode.gain.setValueAtTime(0.2,audioCtx.currentTime);
        setTimeout(()=>{
          flash.style.background='black';
          gainNode.gain.setValueAtTime(0,audioCtx.currentTime);
        },onTime);
      }
      stimInterval=setInterval(cycle,period);
      cycle();
    }

    function stopAV(){
      running=false;
      controls.style.display='block';
      flash.style.background='black';
      if(stimInterval)clearInterval(stimInterval);
      if(osc){try{osc.stop();osc.disconnect();}catch(e){}osc=null;}
      if(gainNode){try{gainNode.disconnect();}catch(e){}gainNode=null;}
    }

    function handleStart(){
      if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
      audioCtx.resume().then(()=>{
        console.log('AudioContext state:',audioCtx.state);
        playClickUnlock(); // force iOS to allow sound
        setTimeout(()=>{
          if(!running) startAV();
        },50);
      }).catch(err=>console.log('Audio unlock failed',err));
    }

    toggle.onclick=handleStart;
    toggle.ontouchend=handleStart;

    flash.onclick=()=>{if(running)stopAV();};
    flash.ontouchend=()=>{if(running)stopAV();};
  </script>
</body>
</html>

